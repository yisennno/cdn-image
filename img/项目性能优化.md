## 压力测试目标
- 负载上升各项指标是否正常
- 发现性能短板
- 高并发下系统是否稳定
- 预估系统最大负载
## 压力测试指标
重点关注前三个
![](https://cdn.nlark.com/yuque/0/2024/webp/40371534/1710393152676-7b9e0a88-4d66-4d47-80a2-85836160181a.webp#averageHue=%23e1e1e1&clientId=ude8ea890-a802-4&from=paste&id=uf645352b&originHeight=289&originWidth=1231&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ue48c9ab7-08be-4b79-ba68-53298857b51&title=)
## 性能关键指标分析
JMeter：

- RT、压力机活动线程数、TPS、QPS、吞吐量

服务器：

- CPU、内存、网络IO、磁盘IO
- 系统负载 load average：表示繁忙程度，单核<1游刃有余，等于1无额外资源处理，大于1其他需要资源的都堵着。
## 性能测试监控工具
Linux系统的命令：top、vmstat、iostat、ss、netstat
可视化监控：Prometheus+Grafana+InfluxDB+Skyworking
其他监控工具：nmon、arthas
## 搭建性能测试平台
### 服务器硬件资源监控
#### 搭建前置，安装JMeter
[JMeter](https://www.yuque.com/moaomao-7ry4a/xzvmdm/tyu8rvev72psvqd8?view=doc_embed)
#### JMeter压测工具perfmon
##### 配置服务端代理
[ServerAgent 下载](https://github.com/undera/perfmon-agent)，改脚本，开放安全组端口
```java
nohup java -jar ./CMDRunner.jar --tool PerfMonAgent --udp-port 7879 --tcp-port 7879 > log.log 2>&1 &
```
##### Jmeter配置监视器
JMeter 安装的插件提供的，需要先安装好，再配置监听器。
![1710400407301.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710400424874-fb450f97-7417-4182-b5eb-6dce322c12cd.png#averageHue=%233e4244&clientId=u36f83b45-b1e0-4&from=paste&height=298&id=ubb9a8da9&originHeight=298&originWidth=1013&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12839&status=done&style=none&taskId=ubf7afb49-30af-478e-9216-64348a174ec&title=&width=1013)
![1710400564525.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710400584573-446ca666-9fce-482d-a565-642225478158.png#averageHue=%233f4245&clientId=u36f83b45-b1e0-4&from=paste&height=82&id=u2da408e5&originHeight=82&originWidth=425&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2275&status=done&style=none&taskId=u0a124ad4-5a76-475d-9633-f3844e06732&title=&width=425)
![1710400590918.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710400605792-849a30a8-1a27-4375-86f4-18f3d58a4dde.png#averageHue=%233f4245&clientId=u36f83b45-b1e0-4&from=paste&height=90&id=ue592ea88&originHeight=90&originWidth=420&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2948&status=done&style=none&taskId=u05c0d54c-4002-4814-88d5-282c55779e3&title=&width=420)
![1710400615239.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710400631149-a98856f3-740d-4754-a12c-fb305658aecc.png#averageHue=%233f4244&clientId=u36f83b45-b1e0-4&from=paste&height=94&id=u9772bded&originHeight=94&originWidth=459&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2901&status=done&style=none&taskId=ubf0d2732-1506-4777-b167-b896d19a5e7&title=&width=459)
![1710400345775.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710400358056-0f685974-e2f7-4ad4-9545-af4b82183fc6.png#averageHue=%233a3f43&clientId=u36f83b45-b1e0-4&from=paste&height=365&id=u26005540&originHeight=365&originWidth=468&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22505&status=done&style=none&taskId=uf6eff18b-3037-406e-8294-06b6ec89b72&title=&width=468)
### 压测监控平台（常用）
#### Grafana+Prometheus+node_exporter
![image.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710404961258-bd21bca3-e80a-4bf5-bacc-5b802c5e8d60.png#averageHue=%23f9f9f9&clientId=ub3460b6e-4363-4&from=paste&height=349&id=ub468a033&originHeight=349&originWidth=741&originalType=binary&ratio=1&rotation=0&showTitle=false&size=105645&status=done&style=none&taskId=u68cc2aca-6c3d-40b4-aa07-dfe2d5c7ecf&title=&width=741)
> Docker + JMeter + InfluxDB + Grafana + node_exporter

#### 搭建前置：配置服务器
配置4台阿里云4C8g的计量付费服务器，用完释放资源
操作系统 centos7.9
阿里云5台4c8g；4台压力机2c4g（用于分布式压测）
服务器环境：1台压力机。1台应用服务主机，1台数据库与缓存服务器，1台CICD服务器

- 实例1：CICD服务器4c8g：Nginx，JMeter，CICD
- 实例2：数据库与缓存服务器4c8g：MySQL、Redis、MQ、ES
- 实例3：应用服务器4c8g：Application
- 实例4：监控服务器4c8g：Grafana、Prometheus、InfluxDB
#### 安装InfluxDB
[InfluxDB](https://www.yuque.com/moaomao-7ry4a/xzvmdm/uuf9m5incnh3ggds?view=doc_embed)
#### 设置JMeter脚本后端监听器
![1710439569415.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710439582881-77977855-5e2a-4c4f-9ba1-b283d452e2c1.png#averageHue=%233c4144&clientId=u1610f161-8fae-4&from=paste&height=432&id=u8f6d0012&originHeight=432&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14475&status=done&style=none&taskId=u884b783e-cb18-4e87-824e-7c482d5e578&title=&width=921)
到此，跑一下压测，influxDB中jmeter数据库就有数据了，接下来需要接入grafana。
#### 安装Grafana
[Grafana + Prometheus](https://www.yuque.com/moaomao-7ry4a/xzvmdm/vcecgfzimc1r7txi?view=doc_embed)
##### 添加、配置数据源
关联influxdb数据源
![1710440143776.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710440161816-d4647a6c-608d-4deb-8b44-45dc78159a8c.png#averageHue=%23191d24&clientId=u0f5f068c-2e29-4&from=paste&height=1077&id=u9ab16015&originHeight=1077&originWidth=943&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82639&status=done&style=none&taskId=uc27f0c82-439b-4e52-b062-2a7d18ade6d&title=&width=943)
##### 导入模板
[官网模板地址](https://grafana.com/grafana/dashboards/)
![1710440284202.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710440296307-c4f65b9e-b2f2-4942-b153-3d422abac5b6.png#averageHue=%2316191e&clientId=u0f5f068c-2e29-4&from=paste&height=722&id=ua0844f65&originHeight=722&originWidth=912&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45992&status=done&style=none&taskId=u0e94b176-953f-47a8-8371-2b91a8c683f&title=&width=912)
[https://grafana.com/grafana/dashboards/5496-apache-jmeter-dashboard-by-ubikloadpack/](https://grafana.com/grafana/dashboards/5496-apache-jmeter-dashboard-by-ubikloadpack/)
Apache提供的后端监听器，直接粘ID 5496，打开压测，就可以看到数据了。
![1710440698146.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710440709675-b3de71a3-f5df-4d24-932e-8c6a37a887ba.png#averageHue=%23171a20&clientId=u0f5f068c-2e29-4&from=paste&height=844&id=uad7e024c&originHeight=844&originWidth=1107&originalType=binary&ratio=1&rotation=0&showTitle=false&size=62501&status=done&style=none&taskId=uf438b797-dd9b-423c-a71f-580a73a2aca&title=&width=1107)
#### 安装node_exporter
安装后启动
[node exporter](https://www.yuque.com/moaomao-7ry4a/xzvmdm/ht1y3c4yir10gg5q?view=doc_embed)
#### 安装prometheus
前面已安装，更改配置，配置文件位置在安装时挂载的地址，修改之后重启容器
```java
global:
  scrape_interval: 10s

scrape_configs:
  - job_name: 'test-job'
    metrics_path: '/metrics'   // 修改
    static_configs:
      # 注意IP换为你的应用IP:Port
      - targets: [ '139.9.193.70:9100' ]   // 修改
```
#### 导入适合node_exporter的模板
11074（EN）、16098（CN）
## 梯度压测：分析接口性能瓶颈
RT与服务端线程数有相关性 ---> tomcat
### 压测配置
模拟低延时场景01，用户访问接口并发逐渐增加的过程。
预计接口响应时间为20ms

- 线程梯度：5、10、15、20、25、30、35、40个线程
- 循环请求次数5000次
- 时间设置：Ramp-up period 值设置为对应线程数
   - 测试总时长：约等于20ms * 5000 * 8组 = 800s = 13分
- 配置断言：超过3s，响应状态码不为200，则为无效请求
### 机器环境

- 应用服务器配置：4c8g
   - 外网带宽 25Mbps
   - 内网带宽基础1.5/最高10Gbit/s
- 集群规模：单节点
- 服务版本：v1.0
- 数据库服务器配置：4c8g
### 配置监听器

- 聚合报告
- 查看结果树
- 活跃线程数：压力机中活跃线程数
- TPS统计分析：每秒事务数
- RT统计分析：响应时间
- 后端监听器：将压测信息汇总到influxdb，在grafana中呈现
- 压测监控平台：
   - JMeter Dashboard
   - 应用服务器：内存、网络、磁盘、系统负载情况
   - MySQL服务器：内存、网络、磁盘、系统负载情况
### 性能瓶颈剖析
#### 梯度压测，测出瓶颈
进一步提升压力，发现性能瓶颈

- 使用线程： 5，循环5000次，共2.5w个样本
- 使用线程： 10，循环5000次，共5w个样本
- 使用线程： 15，循环5000次，共7.5w个样本
- 使用线程： 20，循环5000次，共10w个样本
- 使用线程： 25，循环5000次，共12.5w个样本
- 使用线程： 30，循环5000次，共15w个样本
- 使用线程： 35，循环5000次，共17.5w个样本
- 使用线程： 40，循环5000次，共20w个样本
#### 问题1:网络达到瓶颈
观察监控：随着压力上升，TPS不再增加，接口响应逐渐增加，偶尔出现异常，瓶颈凸显，系统的负载不高。CPU、内存正常，说明系统这部分利用率不高，带宽显然已经触顶了。
##### 优化方案

- 方案1 - 降低接口响应数据包大小
- 方案2 - 提升带宽 或者 在内网压测
##### 思考
可不可以基于RT与TPS算出服务端并发线程数？
**服务端线程数计算公式：TPS /（1000ms/RT均值）**
> - RT=21ms，TPS=800，服务端线程数 = 800 / (1000ms/RT均值) = 17
> - RT=500ms，TPS=800，服务端线程数 = 800 / (1000ms/RT均值) = 400
> - RT=1000ms，TPS=800，服务端线程数 = 800 /(1000ms/RT均值) = 800

结论：

- 在低延时场景下，服务瓶颈主要在服务端带宽
- TPS数量 = 服务端线程数 *（1000ms/ RT均值）
#### 问题2：接口响应时间是否正常？
模拟高延时场景02，用户访问接口并发逐渐增价的过程。接口响应时间为500ms

- 线程梯度：100、200、300、400、500、600、700、800个线程
- 循环请求200次
- 时间设置：Ramp-up period 设置为对应线程数的1/10
   - 测试总时长：约等于 500ms * 200 * 8组 = 13分
- 配置断言：超过3s，响应状态码不是200，则为无效状态

观察监控：带宽使用不高，线程达到瓶颈。
结论：

- 在高延时场景下，服务瓶颈主要在容器最大并发线程数
- RT=500ms，TPS=800，服务端线程数 = 800 / (1000ms/RT均值) = 400
   - tomcat默认最大并发线程数 200
#### 问题3：TPS在上升到一定值之后，异常率较高

- 与IO模型有关系，当前使用的时阻塞式IO模型
- 重点在于并发编程与网络编程
## 分布式压测
使用jmeter做大并发压力测试场景下，单机受限内存、cpu、网络io，会出现服务器压力还没上去，但是压测机压力太大已经死了，为了让jmeter拥有更强大的负载能力，jmeter提供分布式压测能力。
![1710452526430.png](https://cdn.nlark.com/yuque/0/2024/png/40371534/1710452543872-c1d07ad7-bfd5-403e-8f2d-1e7765efd6ee.png#averageHue=%23f3f3f3&clientId=u0f5f068c-2e29-4&from=paste&height=287&id=u0e25c0a9&originHeight=287&originWidth=840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=83655&status=done&style=none&taskId=u90e750e8-4f00-4152-862d-aff912f6142&title=&width=840)
### 搭建JMeter Master控制机和JMeter Salve施压机

- 第一步：三台slave搭建在linux环境下
- 第二步：master搭建在windows下，方便观看，也可以在linux下
> 搭建注意:
> - 需要保证slave和server都在同一个网络。多网卡环境，则需要保证启动的网卡在一个网段。
> - 保证server和slave之间的时间是同步的
> - 在内网配置Jmeter主从通信端口，1个固定，1个随机，简单的配置方式就是关闭防火墙，但存在安全隐患。

### slave配置

1. 下载安装
2. 配置修改rmi主机hostname
```java
# 改ip
vim bin/jmeter-server
# RMI_HOST_DEF=.....=本机ip  // 用内网ip就行

# 改端口
vim jmeter.properties
server_port=1099

server.rmi.port=1098
```

3. 配置关闭 server.rmi.ssl
```java
server.rmi.ssl.disable=true
```

4. 启动 jmeter-server 服务
```java
nohup ./jmeter-server > ./jmeter.out 2>&1 &
```
### 分布式环境配置

1. 确保master,slave安装
2. slave启动，监听1099端口
3. master, bin/jmeter.properties，修改远程主机选项，添加3个slave服务器地址
```java
remote_hosts=172.17.188.40:199,172.17.188.41:199,172.17.188.42:199
```

4. 启动jmeter，如果是多网卡需要指定ip地址启动
```java
jmeter -Djava.rmi.server.hostname=172.17.188.45
```

5. 验证分布式环境是否搭建成功，看master gui界面，运行-远程启动（所有）

## 其他补充
**服务器资源监控**
```shell
1.网络资源情况：可以使用 sar -n DEV 10 120 命令，10代表10秒执行一次，总共执行120次，由下图可见 rxkB/s：每秒钟接收数据量，单位kb，  txkB/s：每秒钟发送数据量，单位kb ，每秒接收和发送没超过6M每秒，可以使用ifconfig命令查看网卡名称，然后使用ethtool eth0  查看当前服务器的带宽配置，由截图可知，当前网速带宽万M，每秒传输可达1000多M每秒，使用率不到1%，6M不考虑网络瓶颈
```
```shell
2.硬盘读写情况：可以使用iostat -x k 1 5命令，1代表1秒执行一次，总共执行5次，由图可知，总共有5块磁盘，磁盘最大读取900kb/S，最大写入2.2M/S，目前磁盘读取写入速度都是100M以上了，2M不考虑磁盘瓶颈，也可以关注%util指标，%util 表示磁盘忙碌情况，一般该值超过80%表示该磁盘可能处于繁忙状态
```
```shell
3.cpu负载情况：可以使用uptime命令，while true; do uptime; sleep 60; done 该命令能持续执行uptime命令，每隔1分钟执行一次，显示最近1、5、15分钟cpu负载情况，由下图可知，负载量最高为5，该服务器cpu核心数为4(上面硬盘、网络命令均有显示4CPU)，如果超过4*1.7=6.8，考虑负载过高，sar - u 10 120，该命令用来查看所有cpu的使用率，由下图可知user+system的cpu使用率75%，未超过90%，不考虑CPU处理瓶颈，也可以使用 sar -P 0 1 2命令跟踪具体的cpu， 该命令0代表第一块CPU
```
```shell
4.内存使用情况 ：使用free命令即可下图的while true; do free; sleep 10; done为每10秒执行一次，由图可见8G内存只使用了2.1G，可被应用程序使用的物理内存还有4.4G，不考虑内存瓶颈
```
```shell
5.应用服务(java类型)监听：首先输入jps -l ，该命令是显示当前系统所有的java进程，最前面显示的是进程id，找到当前应用服务的进程id，输入jstat -gcutil 29033 10000    29033代表进程id，10000代表10秒输出一次，该命令是跟踪java进程内存使用情况，由图可知FGC(主要关注该参数，代表回收老年代，每次回收应用都需要等待)总共发生了6次，压测期间没有增加，FGCT是FGC耗时24秒，如果频繁fgc考虑调整该服务内存大小，该服务进程内存满足需求
```
```shell
6.下图使用nmon进行监控，推荐使用该开源工具，./nmon -f -s5 -c10代表每隔5秒采集一次，采集10次，该工具可以监控到cpu、内存、硬盘、网络各种指标
```
